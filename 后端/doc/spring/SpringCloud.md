




![image-20211108205935338](https://gitee.com/Sean0516/image/raw/master/img/image-20211108205935338.png)



### spring cloud 的核心组件有哪些

- 服务注册于发现 --- Eureka  Nacos  Zookeeper Consul
- 负载均衡（从一个服务的多台机器中选择一台 ） Ribbon  LoadBalancer 
- 服务调用 （基于动态代理机制，根据注解和选择的机器，拼接请求 url 地址，发起请求）Feign OpenFeign
- 服务熔断降级（提供线程池，不同的服务走不同的线程池，实现了不同服务调用的隔离，避免了服务雪崩的问题） Hystrix , Resilience4j  , alibaba sentinel 
- 服务网关  Zuul  gateWay
- 配置中心  Config  Apollo  Nacos 
- 链路追踪   sleuth   
- 服务总线  bus   nacos 



### 什么是服务雪崩，什么是服务限流

1. 当服务A 调用服务B ，服务B 调用C ，此时大量请求突然请求服务A ，加入服务A 本身可以抗住这些请求，但是如果服务C 扛不住，导致服务C 请求堆积，从而服务B 请求堆积。 从而服务A 不可用，这就是服务雪崩。 解决方式是服务降级和服务熔断
2. 服务限流是指高并发请求下，为了保护系统，可以对访问服务的请求进行数量上的限制，从而防止系统不被大量请求压垮。



### 什么是服务熔断？什么是服务降级

熔断机制是应对雪崩效应的一种微服务链路保护机制。当某个微服务不可用或者响应时间太长时，会进行服务降级，进而熔断该节点微服务的调用，快速返回“错误”的响应信息。当检测到该节点微服务调用响应正常后恢复调用链路。在SpringCloud框架里熔断机制通过Hystrix实现，Hystrix会监控微服务间调用的状况，当失败的调用到一定阈值，缺省是5秒内调用20次，如果失败，就会启动熔断机制

服务降级，一般是从整体负荷考虑。就是当某个服务熔断之后，服务器将不再被调用，此时客户端可以自己准备一个本地的fallback回调，返回一个缺省值。这样做，虽然水平下降，但好歹可用，比直接挂掉强

熔断是下游服务故障触发的，降级是为了降低系统负载



### Erueka 注册中心

#### Eureka 服务端

​		也称为注册中心，同其他服务注册中心一样， 支持高可用配置 。如果Eureka以集群模式部署，当集群中有分片出现故障时，那么Eureka就转入自我保护模式。它允许在分片故障期间继续提供服务的发现和注册，当故障分片恢复运行时，集群中其他分片会把它们的状态再次同步回来

#### Eureka 客户端

​	主要处理服务的注册与发现。客户端服务通过注解和参数配置的方式，嵌入在客户端应用程序的代码中，在应用程序运行时，Eureka客户端想注册中心注册自身提供的服务并周期性地发送心跳来更新它的服务租约。同时，它也能从服务端查询当前注册的服务信息并把它们缓存到本地并周期性地刷新服务状态



### Eureka关键源码解读

#### getServiceUrlsFromConfig

#### 服务注册和续约



### Ribbon 负载均衡

提供负载均衡，有多种负载均衡策略可供选择, 配和服务发现和断路器使用

Ribbon是一个基于HTTP和TCP的客户端负载均衡器，它可以在通过客户端中配置的ribbonServerList服务端列表去轮询访问以达到服务均衡的作用。
当Ribbon和Eureka联合使用时，Ribbon的服务实例清单RibbonServerList会被DiscoveryEnabledNIWSServerList重写，扩展成从Eureka注册中心中获取服务端列表。同时它也会用NIWSDiscoveryPing来取代IPing，它将职责委托给Eureka来去定服务端是否已经启动

在客户端负载均衡中，所有客户端节点都维护着自己要访问的服务端清单，而这些服务端的清单来自于服务注册中心（比如Eureka）。在客户端负载均衡中也需要心跳去维护服务端清单的健康性，只是这个步骤需要与服务注册中心配合完成。
通过Spring Cloud Ribbon的封装，我们在微服务架构中使用客户端负载均衡调用只需要如下两步：

1. 服务提供者只需要启动多个服务实例并且注册到一个注册中心或是多个相关联的服务注册中心
2. 服务消费者直接通过调用被@LoadBalanced注解修饰过的RestTemplate来实现面向服务的接口调用

### Ribbon 负载均衡原理

1. Ribbon 通过ILoadBalance 接口对外提供统一的选择服务器的功能，此接口会根据不同的负载均衡策略 IRole 选择合适的Server 返回给使用者
2. IRole 是负载均衡策略的接口  ILoadBalance 通过调用IRole  的choose 方法返回server
3. IPing 用来检测Server 是否可用。 ILoadBalancer 的实现类，维护了一个Timer  每个10 s 检测一次Server 的可用状态
4. IClientConfig 主要定义了用于初始化客户端和负载均衡器的配置信息



### 什么是 Hystrix

Hystrix 是一个延迟和容错库，旨在隔离远程系统，服务和第三方库的访问点，当出现故障是不可避免的故障时，停止级联故障并在复杂的分布式系统中实现弹性。通常对于使用微服务架构开发的系统，涉及到许多微服务。这些微服务彼此协作 。提供线程池不同的服务走不同的线程池，实现了不同服务调用的隔离，避免了服务器雪崩的问题 
Hystrix具备服务降级、服务熔断、线程和信号隔离、请求缓存、请求合并以及服务监控等强大功能
Hystrix使用舱壁模式实现线程池的隔离，它会为每一个依赖服务创建一个独立的线程池，这样就算某个依赖服务出现延迟过高的情况，也只是对该依赖服务的调用产生影响，而不会拖慢其他的依赖服务

Hystrix 通过Spring AOP 来实现

### Hystrix 的实现原理

正常情况下，断路器关闭，服务消费者请求正常的微服务

一段时间内，失败率达到了一定阈值，断路器将打开，此时不再请求服务提供者，而是返回快速失败方法

断路器打开一段时间后，自动进入半开状态，此时，断路器运行一个请求方法提供者，如果请求调用成功，则关闭断路器 ，否则继续保持断路器打开状态





### 什么是 Netflix Feign？它的优点是什么

​	基于动态代理机制，根据注解和选择的机器，拼接请求URL 地址，发起请求  Feign 的关键机制是使用了动态代理

1. 首先，对某个接口定义了@FeignClient 注解 Feign 就会正对这个接口创建一个动态代理
2. 接着调用接口的时候，本质就是调用Fegin创建的动态代理
3. Feign 的动态代理会根据接口上的@RequestMapping 等注解，来动态构造要请求的服务地址
4. 针对这个地址,发起请求，解析响应

### Config  配置中心是如何实现自动刷新的

1. 配置中心server 端承担起配置刷新的职责
2. 提交配置触发post 请求 给server 端的bus/refresh 接口
3. server 端接收到请求并发送给spring  cloud  bus 总线
4. spring cloud bus 接收到消息并通知给其他连接到总线的客户端
5. 其他客户端接收到通知，请求server 端最新配置
6. 全部客户端均获取到最新配置

### 配置中心是如何保证数据安全的

1. 保证容器文件访问的安全性，保证所有的网络资源请求都需要登录
2. 将配置中心里面所有的配置文件中的密码进行加密，保证其密文性
3. 开发环境禁止拉去生产环境的配置文件

### SpringCloud 和 Dubbo 有哪些区别

首先，他们都是分布式管理框架。

1. dubbo 是二进制传输，占用带宽会少一点。SpringCloud是http 传输，带宽会多一点，同时使用http协议一般会使用JSON报文，消耗会更大
2. dubbo 开发难度较大，所依赖的 jar 包有很多问题大型工程无法解决。SpringCloud 对第三方的继承可以一键式生成，天然集成
3. SpringCloud 接口协议约定比较松散，需要强有力的行政措施来限制接口无序升级
4. 最大的区别: Spring Cloud抛弃了Dubbo 的RPC通信，采用的是基于HTTP的REST方式



### 什么是 Spring Cloud Bus

spring cloud bus 将分布式的节点用轻量的消息代理连接起来，它可以用于广播配置文件的更改或者服务直接的通讯，也可用于监控。如果修改了配置文件，发送一次请求，所有的客户端便会重新读取配置文件



### Spring Cloud Gateway

Spring Cloud Gateway是Spring Cloud官方推出的第二代网关框架，取代Zuul网关。网关作为流量的，在微服务系统中有着非常作用，网关常见的功能有路由转发、权限校验、限流控制等作用

### Ribbon和Feign的区别

1. Ribbon都是调用其他服务的，但方式不同
2. 启动类注解不同，Ribbon是@RibbonClient feign的是@EnableFeignClients
3. 服务指定的位置不同，Ribbon是在@RibbonClient注解上声明，Feign则是在定义抽象方法的接口中使用@FeignClient声明
4. 调用方式不同，Ribbon需要自己构建http请求，模拟http请求然后使用RestTemplate发送给其他服务，步骤相当繁琐。Feign需要将调用的方法定义成抽象方法即可

# Spring Cloud Alibaba

